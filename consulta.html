<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRST SYSTEM - Consulta de Estatus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ... (Mant√©n todos los estilos CSS previos) ... */
        /* (El CSS se mantiene igual que en el c√≥digo anterior) */
    </style>
</head>
<body>

<a href="https://wa.me/584129020243" class="whatsapp-float fade-in" target="_blank" aria-label="Contactar por WhatsApp">
    <i class="bi bi-whatsapp"></i>
</a>

<div class="container-main slide-up">
    <div class="form-container">
        <div class="company-header">
            <img src="https://raw.githubusercontent.com/r0g3rca/rma_firstsystem/main/Header.png" alt="First System Logo" class="company-logo">
        </div>

        <h1 class="form-title">Consulta de Estatus</h1>

        <div class="input-group">
            <label class="input-label">INGRESE N¬∞ DE ORDEN</label>
            <input type="text" id="inputOrden" class="form-input" placeholder="Ej: 1111" autocomplete="off">
        </div>

        <button class="submit-btn" onclick="consultarOrden()" id="consultarBtn">
            <span class="btn-text">Consultar Ahora</span>
        </button>

        <!-- Mensaje de depuraci√≥n -->
        <div id="debugInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; font-family: monospace;">
            <strong>Informaci√≥n de Depuraci√≥n:</strong>
            <div id="debugContent"></div>
        </div>

        <!-- Ticket de resultado -->
        <div id="ticket" class="ticket-result">
            <!-- ... (mant√©n la estructura del ticket) ... -->
        </div>

        <div class="social-container">
            <!-- ... (mant√©n los enlaces sociales) ... -->
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzpD2MIOA1r_aSM3ifDU6m86LCufQLnXmkMiGDjX4kU_hSoclHAPc5zanmxZeiKQe6zEw/exec';

    // Funci√≥n para mostrar informaci√≥n de depuraci√≥n
    function showDebugInfo(info) {
        const debugDiv = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');
        
        debugContent.innerHTML = `
            <p><strong>URL solicitada:</strong> ${info.url}</p>
            <p><strong>Orden consultada:</strong> ${info.orden}</p>
            <p><strong>Respuesta HTTP:</strong> ${info.status}</p>
            <p><strong>Estado:</strong> ${info.statusText}</p>
            <p><strong>Respuesta cruda:</strong></p>
            <pre style="background: white; padding: 10px; border-radius: 5px; overflow: auto;">${JSON.stringify(info.rawResponse, null, 2)}</pre>
            <p><strong>Error:</strong> ${info.error || 'Ninguno'}</p>
        `;
        debugDiv.style.display = 'block';
    }

    // Funci√≥n para probar diferentes formatos de respuesta
    async function testConnection() {
        const testOrden = '1111'; // N√∫mero de prueba
        const testUrl = `${SCRIPT_URL}?orden=${testOrden}`;
        
        console.log('üîç Probando conexi√≥n con:', testUrl);
        
        try {
            const response = await fetch(testUrl);
            console.log('üìä Respuesta recibida:', response);
            
            // Intentar diferentes formas de leer la respuesta
            const textResponse = await response.text();
            console.log('üìÑ Respuesta en texto:', textResponse);
            
            // Intentar parsear como JSON
            try {
                const jsonResponse = JSON.parse(textResponse);
                console.log('‚úÖ JSON parseado:', jsonResponse);
                return { success: true, data: jsonResponse, raw: textResponse };
            } catch (e) {
                console.log('‚ö†Ô∏è No es JSON v√°lido, es texto plano:', textResponse);
                return { success: false, data: null, raw: textResponse };
            }
        } catch (error) {
            console.error('‚ùå Error en la conexi√≥n:', error);
            return { success: false, error: error.message, data: null };
        }
    }

    async function consultarOrden() {
        const orden = document.getElementById('inputOrden').value.trim();
        const ticket = document.getElementById('ticket');
        const mensaje = document.getElementById('mensaje');
        const btn = document.getElementById('consultarBtn');
        const btnText = btn.querySelector('.btn-text');

        // Ocultar ticket anterior y mensaje
        ticket.style.display = 'none';
        
        if (!orden) {
            alert('Por favor, ingrese un n√∫mero de orden');
            return;
        }

        // Mostrar estado de carga
        const originalText = btnText.textContent;
        btnText.innerHTML = '<span class="loading"></span>Buscando...';
        btn.disabled = true;

        try {
            // Opci√≥n 1: Consulta directa (como estaba originalmente)
            const url = `${SCRIPT_URL}?orden=${encodeURIComponent(orden)}`;
            console.log('üîó URL de consulta:', url);
            
            const response = await fetch(url);
            console.log('üì° Respuesta HTTP:', response);
            
            // Mostrar informaci√≥n de depuraci√≥n
            showDebugInfo({
                url: url,
                orden: orden,
                status: response.status,
                statusText: response.statusText,
                rawResponse: await response.text()
            });
            
            // Re-hacer la petici√≥n para procesar la respuesta
            const response2 = await fetch(url);
            let data;
            
            // Intentar diferentes formatos de respuesta
            try {
                // Primero intentar como JSON
                data = await response2.json();
            } catch (jsonError) {
                // Si falla, intentar como texto
                const textResponse = await response2.text();
                console.log('üìÑ Respuesta en texto:', textResponse);
                
                // Intentar extraer datos de diferentes formatos
                if (textResponse.includes('orden') || textResponse.includes('descripcion')) {
                    // Buscar datos en el texto
                    const ordenMatch = textResponse.match(/orden["':\s]*([^,}\s]+)/i);
                    const descripcionMatch = textResponse.match(/descripcion["':\s]*([^,}\s]+)/i);
                    
                    data = {
                        orden: ordenMatch ? ordenMatch[1] : orden,
                        descripcion: descripcionMatch ? descripcionMatch[1] : 'No disponible',
                        serial: 'No disponible',
                        falla: 'No disponible',
                        estatus: 'EN PROCESO',
                        detalle: 'Datos obtenidos del sistema'
                    };
                } else {
                    throw new Error('Formato de respuesta no reconocido');
                }
            }
            
            // Procesar los datos recibidos
            if (data) {
                console.log('‚úÖ Datos procesados:', data);
                
                // Mapear los campos (ajusta seg√∫n la estructura real de tu script)
                const orderData = {
                    orden: data.orden || data.numeroOrden || data.Numero || orden,
                    descripcion: data.descripcion || data.equipo || data.Descripcion || 'No disponible',
                    serial: data.serial || data.Serial || 'No disponible',
                    falla: data.falla || data.Falla || data.problema || 'No disponible',
                    estatus: data.estatus || data.Estatus || data.status || 'PENDIENTE',
                    detalle: data.detalle || data.Detalle || data.diagnostico || 'Pendiente de diagn√≥stico...',
                    fecha: data.fecha || data.Fecha || data.fechaIngreso || 'No registrada',
                    tecnico: data.tecnico || data.Tecnico || data.responsable || 'Por asignar'
                };
                
                // Actualizar la interfaz con los datos
                updateTicket(orderData);
                
                // Mostrar ticket
                ticket.style.display = 'block';
                
                alert('‚úÖ Orden encontrada en el sistema');
            } else {
                throw new Error('No se recibieron datos de la orden');
            }

        } catch (error) {
            console.error('‚ùå Error en la consulta:', error);
            
            // Mostrar informaci√≥n detallada del error
            showDebugInfo({
                url: `${SCRIPT_URL}?orden=${orden}`,
                orden: orden,
                error: error.message,
                rawResponse: error.toString()
            });
            
            alert('‚ùå Error al consultar la orden. Revise la consola para m√°s detalles.');
            
        } finally {
            // Restaurar bot√≥n
            btnText.textContent = originalText;
            btn.disabled = false;
        }
    }

    // Funci√≥n para actualizar el ticket con datos
    function updateTicket(data) {
        document.getElementById('res-orden').textContent = data.orden;
        document.getElementById('res-equipo').textContent = data.descripcion;
        document.getElementById('res-serial').textContent = data.serial;
        document.getElementById('res-falla').textContent = data.falla;
        document.getElementById('res-fecha').textContent = data.fecha;
        document.getElementById('res-tecnico').textContent = data.tecnico;
        document.getElementById('res-diagnostico').textContent = data.detalle;

        // Configurar badge seg√∫n estatus
        const badge = document.getElementById('estatusBadge');
        const status = data.estatus ? data.estatus.toUpperCase() : 'PENDIENTE';
        
        badge.textContent = `ESTATUS: ${status}`;
        badge.className = 'status-badge ';
        
        // Aplicar clase seg√∫n estatus
        if (status.includes('PENDIENTE') || status.includes('RECIBIDO')) {
            badge.classList.add('status-pending');
        } else if (status.includes('PROCESANDO') || status.includes('REPARACI√ìN')) {
            badge.classList.add('status-processing');
        } else if (status.includes('LISTO') || status.includes('REPARADO')) {
            badge.classList.add('status-ready');
        } else if (status.includes('ENTREGADO') || status.includes('FINALIZADO')) {
            badge.classList.add('status-delivered');
        } else {
            badge.classList.add('status-processing');
        }
    }

    // Funci√≥n para probar el script manualmente
    async function testScript() {
        console.log('üß™ Iniciando prueba del script...');
        const result = await testConnection();
        
        if (result.success) {
            console.log('‚úÖ Conexi√≥n exitosa. Estructura de datos:', result.data);
            alert('‚úÖ Conexi√≥n exitosa. Revisa la consola para ver la estructura de datos.');
        } else {
            console.log('‚ùå Conexi√≥n fallida. Respuesta:', result.raw);
            alert('‚ùå Conexi√≥n fallida. Revisa la consola para m√°s detalles.');
        }
    }

    // Permitir consultar con Enter
    document.getElementById('inputOrden').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            consultarOrden();
        }
    });

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ P√°gina de consulta cargada');
        console.log('üìã Script URL:', SCRIPT_URL);
        
        // Opcional: Probar autom√°ticamente al cargar
        // testScript();
        
        // Verificar si hay un par√°metro de orden en la URL
        const urlParams = new URLSearchParams(window.location.search);
        const ordenParam = urlParams.get('orden');
        
        if (ordenParam) {
            document.getElementById('inputOrden').value = ordenParam;
            console.log('üîç Orden desde URL:', ordenParam);
        }
    });
</script>

<!-- Bot√≥n para depuraci√≥n (opcional) -->
<button onclick="testScript()" style="position: fixed; bottom: 100px; right: 30px; z-index: 1000; padding: 10px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
    üîß Probar Script
</button>

</body>
</html>
